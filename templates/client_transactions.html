{% extends "base.html" %}

{% block title %}Transactions for {{ client.client_name }} - Ledger System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Transactions for {{ client.client_name }}</h2>
    <a href="{{ url_for('clients') }}" class="btn btn-secondary">Back to Clients</a>
</div>

{% if transactions %}
<!-- Desktop Table View -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>S.No</th>
                <th>ID</th>
                <th>Applicant Name</th>
                <th>App ID</th>
                <th>Country</th>
                <th>Country Price</th>
                <th>Rate</th>
                <th>Addition</th>
                <th>Amount</th>
                <th>Amount N</th>
                <th>Email/Link</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr class="{% if transaction.is_paid %}row-paid{% endif %}">
                <td>{{ loop.index }}</td>
                <td>{{ transaction.id }}</td>
                <td>{{ transaction.applicant_name }}</td>
                <td>{{ transaction.app_id }}</td>
                <td>{{ transaction.country_name }}</td>
                <td>{{ (transaction.country_price or 0)|comma2 }}</td>
                <td>{{ (transaction.rate or 0)|comma2 }}</td>
                <td>{{ (transaction.addition or 0)|comma2 }}</td>
                <td>$ {{ (transaction.amount or 0)|comma2 }}</td>
                <td><strong>{{ (transaction.amount_n or 0)|comma2 }}</strong></td>
                <td>
                    {% if transaction.email_link %}
                    <a href="{{ transaction.email_link }}" target="_blank" class="btn btn-primary btn-sm" style="padding: 2px 6px; font-size: 12px;">Open Link</a>
                    {% endif %}
                </td>
                <td>{{ transaction.transaction_date|date_format }}</td>
                <td>
                    <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-secondary btn-sm">Edit</a>
                    {% if session.permissions and session.permissions.is_admin %}
                    {% if not transaction.is_paid %}
                    <form action="{{ url_for('pay_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Pay {{ transaction.amount_n|comma2 }} from client balance?');">
                        <button type="submit" class="btn btn-success btn-sm">Pay</button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('undo_pay_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Undo payment and restore client balance?');">
                        <button type="submit" class="btn btn-secondary btn-sm">Undo Pay</button>
                    </form>
                    {% endif %}
                    {% endif %}
                    <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Mobile Card View -->
<div class="mobile-card-view">
    {% for transaction in transactions %}
    <div class="mobile-card {% if transaction.is_paid %}card-paid{% endif %}">
        <div class="mobile-card-header">#{{ loop.index }} - Transaction #{{ transaction.id }}</div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Applicant Name:</span>
            <span class="mobile-card-value">{{ transaction.applicant_name }}</span>
        </div>
        <div class="mobile-card-row" style="justify-content: center; align-items: center; gap: 10px;">
            <span class="mobile-card-label-sm">App ID:</span>
            <span class="mobile-card-value-sm" style="font-weight: bold;">{{ transaction.app_id }}</span>
            {% if transaction.email_link %}
            <span class="mobile-card-value-sm">
                <a href="{{ transaction.email_link }}" target="_blank" class="btn btn-primary btn-sm" style="padding: 2px 8px; font-size: 12px;">Open Link</a>
            </span>
            {% endif %}
        </div>
        
        <div class="mobile-card-row" style="justify-content: center; background-color: #f8f9fa; padding: 4px; border-radius: 4px; margin: 4px 0;">
            <span class="mobile-card-value-sm" style="font-weight: bold; width: 100%; text-align: center;">({{ transaction.country_name }} - <span class="country-price-logo">{{ (transaction.country_price or 0)|comma2 }}</span>)</span>
        </div>

        <div class="mobile-card-row mobile-grouped-row">
            <div class="mobile-half-col">
                <span class="mobile-card-label-sm">Rate:</span>
                <span class="mobile-card-value-sm">{{ (transaction.rate or 0)|comma2 }}</span>
            </div>
            <div class="mobile-half-col">
                <span class="mobile-card-label-sm">Addition:</span>
                <span class="mobile-card-value-sm">{{ (transaction.addition or 0)|comma2 }}</span>
            </div>
        </div>

        <div class="mobile-card-row" style="justify-content: center; background-color: #f8f9fa; padding: 4px; border-radius: 4px; margin: 4px 0;">
            <span class="mobile-card-value-sm" style="font-weight: bold; width: 100%; text-align: center;">$ {{ (transaction.amount or 0)|comma2 }} - <strong>â‚¦ {{ (transaction.amount_n or 0)|comma2 }}</strong></span>
        </div>


        <div class="mobile-card-row">
            <span class="mobile-card-label">Date:</span>
            <span class="mobile-card-value">{{ transaction.transaction_date|date_format }}</span>
        </div>
        <div class="mobile-card-actions">
            <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-secondary btn-sm">Edit</a>
            {% if session.permissions and session.permissions.is_admin %}
            {% if not transaction.is_paid %}
            <form action="{{ url_for('pay_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Pay {{ transaction.amount_n|comma2 }} from client balance?');">
                <button type="submit" class="btn btn-success btn-sm" style="width: 100%;">Pay</button>
            </form>
            {% else %}
            <form action="{{ url_for('undo_pay_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Undo payment and restore client balance?');">
                <button type="submit" class="btn btn-secondary btn-sm" style="width: 100%;">Undo Pay</button>
            </form>
            {% endif %}
            {% endif %}
            <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;">ðŸ—‘</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="empty-state">No transactions for this client yet.</p>
{% endif %}
{% endblock %}
