{% extends "base.html" %}

{% block title %}Add Transaction - Ledger System{% endblock %}

{% block content %}
<div class="form-container">
    <h2>Add New Transaction</h2>
    
    {% if error %}
    <div class="alert alert-error">{{ error }}</div>
    {% endif %}
    
    <form method="POST" class="form" id="transactionForm">
        <div class="form-group">
            <label for="client_name">Client Name *</label>
            <select name="client_name" id="client_name" required>
                <option value="">Select a client</option>
                {% for client in clients %}
                <option value="{{ client.client_name }}">{{ client.client_name }}</option>
                {% endfor %}
            </select>
        </div>
        
        
        
        <div class="form-group">
            <label for="service_type">Service Type</label>
            <select name="service_type" id="service_type">
                <option value="eVisa" selected>eVisa</option>
                <option value="Passport">Passport</option>
                <option value="TWP">TWP</option>
                <option value="eCerpac">eCerpac</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="applicant_name">Applicant Name</label>
            <input type="text" name="applicant_name" id="applicant_name">
        </div>
        
        <div class="form-group">
            <label for="app_id">App ID *</label>
            <input type="text" name="app_id" id="app_id" pattern="\d+" title="Numeric ID" required>
        </div>
        
        <div class="form-group">
            <label for="country_name">Country *</label>
            <select name="country_name" id="country_name" required>
                <option value="">Select a country</option>
                {% for country in countries %}
                <option value="{{ country.name }}" data-price="{{ country.price }}">{{ country.name }}</option>
                {% endfor %}
            </select>
            <small id="countryPriceDisplay"></small>
        </div>
        
        <div class="form-group">
            <label for="rate">Rate</label>
            <input type="number" step="0.01" name="rate" id="rate">
        </div>
        
        <div class="form-group">
            <label for="add">Add</label>
            <input type="number" step="0.01" name="add" id="add">
        </div>

        <div class="form-group">
            <label for="transaction_date">Transaction Date</label>
            <input type="date" name="transaction_date" id="transaction_date">
        </div>
        
        <div class="form-group">
            <label>Amount (calculated)</label>
            <input type="text" id="amountDisplay" readonly class="readonly-field">
            <small>üåê + Addition</small>
        </div>
        
        <div class="form-group">
            <label>Amount N (calculated)</label>
            <input type="text" id="amountNDisplay" readonly class="readonly-field">
            <small>Amount √ó Rate</small>
        </div>


        
        <div class="form-group">
            <label for="email_link">Email/Link (Optional)</label>
            <input type="text" name="email_link" id="email_link" placeholder="Enter email or link">
        </div>

        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Add Transaction</button>
            <a href="{{ url_for('transactions') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
</div>

<script>
    const countrySelect = document.getElementById('country_name');
    const serviceTypeSelect = document.getElementById('service_type');
    const rateInput = document.getElementById('rate');
    const additionInput = document.getElementById('add');
    const amountDisplay = document.getElementById('amountDisplay');
    const amountNDisplay = document.getElementById('amountNDisplay');
    const countryPriceDisplay = document.getElementById('countryPriceDisplay');
    
    // Store original options
    const allCountryOptions = Array.from(countrySelect.options).slice(1); // Skip "Select a country"

    function filterCountries() {
        const serviceType = serviceTypeSelect.value;
        const currentSelected = countrySelect.value;
        
        // Clear current options (keep first one)
        while (countrySelect.options.length > 1) {
            countrySelect.remove(1);
        }
        
        const excludedForEVisa = ['32pgs', '32pgs COD', '64pgs', '64pgs COD', 'TWP'];
        const allowedForTWP = ['TWP'];
        const allowedForPassport = ['32pgs', '32pgs COD', '64pgs', '64pgs COD'];
        
        allCountryOptions.forEach(option => {
            let shouldShow = true;
            const name = option.text;
            
            if (serviceType === 'eVisa') {
                if (excludedForEVisa.includes(name)) shouldShow = false;
            } else if (serviceType === 'TWP') {
                if (!allowedForTWP.includes(name)) shouldShow = false;
            } else if (serviceType === 'Passport') {
                if (!allowedForPassport.includes(name)) shouldShow = false;
            }
            // eCerpac shows all
            
            if (shouldShow) {
                countrySelect.add(option.cloneNode(true));
            }
        });
        
        // Restore selection if valid, otherwise reset
        const newOptions = Array.from(countrySelect.options);
        const exists = newOptions.some(opt => opt.value === currentSelected);
        if (exists) {
            countrySelect.value = currentSelected;
        } else {
            countrySelect.value = "";
            calculateAmounts(); // Recalculate (will clear values)
        }
        
        // Sync Tom Select if it exists
        if (countrySelect.tomselect) {
            countrySelect.tomselect.sync();
            countrySelect.tomselect.setValue(countrySelect.value, true);
        }
    }

    serviceTypeSelect.addEventListener('change', filterCountries);
    
    // Initial filter
    filterCountries();

    function calculateAmounts() {
        const selectedOption = countrySelect.options[countrySelect.selectedIndex];
        const countryPrice = parseFloat(selectedOption.dataset.price) || 0;
        const addition = parseFloat(additionInput.value) || 0;
        const rate = parseFloat(rateInput.value) || 1;
        
        const amount = countryPrice + addition;
        const amountN = amount * rate;
        
        amountDisplay.value = Math.round(amount).toLocaleString();
        amountNDisplay.value = Math.round(amountN).toLocaleString();
        
        if (countryPrice > 0) {
            countryPriceDisplay.textContent = `üåê: ${Math.round(countryPrice).toLocaleString()}`;
        } else {
            countryPriceDisplay.textContent = '';
        }
    }
    
    countrySelect.addEventListener('change', calculateAmounts);
    rateInput.addEventListener('input', calculateAmounts);
    additionInput.addEventListener('input', calculateAmounts);

    // Set default transaction date to today
    const dateInput = document.getElementById('transaction_date');
    if (dateInput && !dateInput.value) {
        const today = new Date().toISOString().slice(0, 10);
        dateInput.value = today;
    }
</script>
{% endblock %}

