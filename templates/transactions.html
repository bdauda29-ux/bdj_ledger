{% extends "base.html" %}

{% block title %}Transactions - Ledger System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Transactions</h2>
    <a href="{{ url_for('add_transaction') }}" class="btn btn-primary">Add New Transaction</a>
    <a href="{{ url_for('transactions_bin') }}" class="btn btn-secondary">Bin</a>
</div>
<!-- Tabs -->
<div class="tabs">
    <a class="tab {% if filters.paid == 'all' %}active{% endif %}" href="{{ url_for('transactions', paid='all') }}">All</a>
    <a class="tab {% if filters.paid == '0' %}active{% endif %}" href="{{ url_for('transactions', paid='0') }}">Pending</a>
    <a class="tab {% if filters.paid == '1' %}active{% endif %}" href="{{ url_for('transactions', paid='1') }}">Paid</a>
    <style>
        .tabs { display:flex; gap:8px; margin-bottom:10px; }
        .tab { padding:6px 10px; border:1px solid #ccc; border-radius:4px; text-decoration:none; }
        .tab.active { background:#eee; }
    </style>
</div>
<!-- Filters -->
<div class="filter-bar">
    <form method="GET" class="filter-form">
        <label>Client:</label>
        <select name="client_name">
            <option value="">All</option>
            {% for c in clients %}
            <option value="{{ c.client_name }}" {% if filters.client == c.client_name %}selected{% endif %}>{{ c.client_name }}</option>
            {% endfor %}
        </select>

        <label>Country:</label>
        <select name="country_name">
            <option value="">All</option>
            {% for c in countries %}
            <option value="{{ c.name }}" {% if filters.country == c.name %}selected{% endif %}>{{ c.name }}</option>
            {% endfor %}
        </select>

        <label>From:</label>
        <input type="date" name="date_from" value="{{ filters.date_from }}">
        <label>To:</label>
        <input type="date" name="date_to" value="{{ filters.date_to }}">
        
        <label>Paid:</label>
        <select name="paid">
            <option value="all" {% if filters.paid == 'all' %}selected{% endif %}>All</option>
            <option value="1" {% if filters.paid == '1' %}selected{% endif %}>Paid</option>
            <option value="0" {% if filters.paid == '0' %}selected{% endif %}>Pending</option>
        </select>

        <button type="submit" class="btn">Filter</button>
        <a href="{{ url_for('transactions') }}" class="btn btn-secondary">Clear</a>
    </form>
</div>

<!-- Export Options -->
<div style="margin: 15px 0; display: flex; gap: 10px;">
    <a href="{{ url_for('export_transactions', format='pdf', client_name=filters.client, country_name=filters.country, date_from=filters.date_from, date_to=filters.date_to) }}" class="btn btn-info">Export PDF</a>
    <a href="{{ url_for('export_transactions', format='jpeg', client_name=filters.client, country_name=filters.country, date_from=filters.date_from, date_to=filters.date_to) }}" class="btn btn-info">Export JPEG</a>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if transactions %}
<!-- Desktop Table View -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>S.No</th>
                <th>ID</th>
                <th>Client Name</th>
                <th>Applicant Name</th>
                <th>App ID</th>
                <th>Country</th>
                <th>Country Price</th>
                <th>Rate</th>
                <th>Add</th>
                <th>Service Type</th>
                <th>Amount</th>
                <th>Amount N</th>
                <th>Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr class="{% if transaction.is_paid %}row-paid{% endif %}">
                <td>{{ loop.index }}</td>
                <td>{{ transaction.id }}</td>
                <td>{{ transaction.client_name }}</td>
                <td>{{ transaction.applicant_name }}</td>
                <td>{{ transaction.app_id }}</td>
                <td>{{ transaction.country_name }}</td>
                <td>{{ (transaction.country_price or 0)|comma2 }}</td>
                <td>{{ (transaction.rate or 0)|comma2 }}</td>
                <td>{{ (transaction.addition or 0)|comma2 }}</td>
                <td>{{ transaction.service_type }}</td>
                <td>$ {{ (transaction.amount or 0)|comma2 }}</td>
                <td><strong>₦ {{ (transaction.amount_n or 0)|comma2 }}</strong></td>
                <td>{{ transaction.email_link or '' }}</td>
                <td>{{ transaction.transaction_date|date_format }}</td>
                <td>
                    <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-secondary btn-sm">Edit</a>
                    {% if session.permissions and session.permissions.is_admin %}
                    {% if not transaction.is_paid %}
                    <form action="{{ url_for('pay_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Pay {{ transaction.amount_n|comma2 }} from client balance?');">
                        <button type="submit" class="btn btn-success btn-sm">Pay</button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('undo_pay_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Undo payment and restore client balance?');">
                        <button type="submit" class="btn btn-secondary btn-sm">Undo Pay</button>
                    </form>
                    {% endif %}
                    {% endif %}
                    <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Mobile Card View -->
<div class="mobile-card-view">
    {% for transaction in transactions %}
    <div class="mobile-card {% if transaction.is_paid %}card-paid{% endif %}">
        <div class="mobile-card-header">#{{ loop.index }} - Transaction #{{ transaction.id }}</div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Client Name:</span>
            <span class="mobile-card-value">{{ transaction.client_name }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Applicant Name:</span>
            <span class="mobile-card-value">{{ transaction.applicant_name }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">App ID:</span>
            <span class="mobile-card-value">{{ transaction.app_id }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Country:</span>
            <span class="mobile-card-value">{{ transaction.country_name }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Country Price:</span>
            <span class="mobile-card-value">{{ (transaction.country_price or 0)|comma2 }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Rate:</span>
            <span class="mobile-card-value">{{ (transaction.rate or 0)|comma2 }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Addition:</span>
            <span class="mobile-card-value">{{ (transaction.addition or 0)|comma2 }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Amount:</span>
            <span class="mobile-card-value">$ {{ (transaction.amount or 0)|comma2 }}</span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Amount N:</span>
            <span class="mobile-card-value"><strong>₦ {{ (transaction.amount_n or 0)|comma2 }}</strong></span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Date:</span>
            <span class="mobile-card-value">{{ transaction.transaction_date|date_format }}</span>
        </div>
        <div class="mobile-card-actions">
            <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-secondary btn-sm">Edit</a>
            {% if session.permissions and session.permissions.is_admin %}
            {% if not transaction.is_paid %}
            <form action="{{ url_for('pay_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Pay {{ transaction.amount_n|comma2 }} from client balance?');">
                <button type="submit" class="btn btn-success btn-sm" style="width: 100%;">Pay</button>
            </form>
            {% else %}
            <form action="{{ url_for('undo_pay_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Undo payment and restore client balance?');">
                <button type="submit" class="btn btn-secondary btn-sm" style="width: 100%;">Undo Pay</button>
            </form>
            {% endif %}
            {% endif %}
            <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;">Delete</button>
            </form>
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="empty-state">No transactions yet. <a href="{{ url_for('add_transaction') }}">Add your first transaction</a></p>
{% endif %}

<!-- Summary and Query Info -->
{% if transactions %}
<div class="transaction-summary" style="margin-top: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
    <h3>Transaction Summary</h3>
    
    <!-- Query Info -->
    <div style="margin-bottom: 15px; padding: 10px; background-color: white; border-radius: 3px;">
        <strong>Query Results:</strong>
        <p style="margin: 5px 0;">
            Total Transactions: <strong>{{ transactions|length }}</strong>
            {% if filters.client %}| Client: <strong>{{ filters.client }}</strong>{% endif %}
            {% if filters.country %}| Country: <strong>{{ filters.country }}</strong>{% endif %}
            {% if filters.date_from %}| From: <strong>{{ filters.date_from }}</strong>{% endif %}
            {% if filters.date_to %}| To: <strong>{{ filters.date_to }}</strong>{% endif %}
        </p>
    </div>
    
    <!-- Sums -->
    <div style="padding: 10px; background-color: white; border-radius: 3px; border-left: 4px solid #28a745;">
        <strong style="font-size: 16px;">Sum Amount:</strong> <span style="font-size: 16px; color: #28a745;">{{ (sums['sum_amount'] or 0)|comma2 }}</span>
        <br>
        <strong style="font-size: 16px;">Sum Amount N:</strong> <span style="font-size: 16px; color: #28a745;">{{ (sums['sum_amount_n'] or 0)|comma2 }}</span>
    </div>
</div>
{% endif %}
{% endblock %}
