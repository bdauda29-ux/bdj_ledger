{% extends "base.html" %}

{% block title %}Transactions - Ledger System{% endblock %}

{% block content %}
<div class="page-header">
    <h2>Transactions</h2>
    <a href="{{ url_for('add_transaction') }}" class="btn btn-primary">Add New Transaction</a>
    <a href="{{ url_for('transactions_bin') }}" class="btn btn-secondary">Bin</a>
</div>
<!-- Tabs -->
<div class="tabs">
    <a href="javascript:void(0)" class="tab active" id="tab-pending" onclick="filterTransactions('0')">Pending</a>
    <a href="javascript:void(0)" class="tab" id="tab-paid" onclick="filterTransactions('1')">Paid</a>
    <a href="javascript:void(0)" class="tab" id="tab-all" onclick="filterTransactions('all')">All</a>
    <style>
        .tabs { display:flex; gap:8px; margin-bottom:10px; }
        .tab { padding:6px 10px; border:1px solid #ccc; border-radius:4px; text-decoration:none; color: #333; }
        .tab.active { background:#eee; font-weight: bold; border-color: #999; }
        .tab:hover { background:#f5f5f5; }
    </style>
</div>
<!-- Filters -->
<div class="filter-bar">
    <form method="GET" class="filter-form" style="display: flex; flex-wrap: wrap; align-items: center; gap: 15px;">
        <div class="filter-group" style="display: flex; align-items: center; gap: 5px;">
            <label style="margin: 0; white-space: nowrap;">Client:</label>
            <select name="client_name" style="width: auto; min-width: 150px;">
                <option value="">All</option>
                {% for c in clients %}
                <option value="{{ c.client_name }}" {% if filters.client == c.client_name %}selected{% endif %}>{{ c.client_name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group" style="display: flex; align-items: center; gap: 5px;">
            <label style="margin: 0; white-space: nowrap;">Country:</label>
            <select name="country_name" style="width: auto; min-width: 150px;">
                <option value="">All</option>
                {% for c in countries %}
                <option value="{{ c.name }}" {% if filters.country == c.name %}selected{% endif %}>{{ c.name }}</option>
                {% endfor %}
            </select>
        </div>

        <div class="filter-group" style="display: flex; align-items: center; gap: 5px;">
            <label style="margin: 0; white-space: nowrap;">Date Range:</label>
            <input type="text" id="date_range" class="form-control" style="width: 220px; margin: 0;" placeholder="Select date range">
            <input type="hidden" name="date_from" id="date_from" value="{{ filters.date_from or '' }}">
            <input type="hidden" name="date_to" id="date_to" value="{{ filters.date_to or '' }}">
        </div>
        
        <div class="filter-actions" style="display: flex; gap: 5px;">
            <button type="submit" class="btn">Filter</button>
            <a href="{{ url_for('transactions') }}" class="btn btn-secondary">Clear</a>
        </div>
    </form>
</div>

<!-- Export Options -->
<div class="export-options" style="margin: 15px 0; display: flex; gap: 10px; flex-wrap: wrap;">
    <a id="export-pdf" href="{{ url_for('export_transactions', format='pdf', client_name=filters.client, country_name=filters.country, date_from=filters.date_from, date_to=filters.date_to, paid='0') }}" class="btn btn-info" style="flex: 1; text-align: center; min-width: 120px;">Export PDF</a>
    <a id="export-jpeg" href="{{ url_for('export_transactions', format='jpeg', client_name=filters.client, country_name=filters.country, date_from=filters.date_from, date_to=filters.date_to, paid='0') }}" class="btn btn-info" style="flex: 1; text-align: center; min-width: 120px;">Export JPEG</a>
</div>

{% if error %}
<div class="alert alert-error">{{ error }}</div>
{% endif %}

{% if transactions %}
<!-- Desktop Table View -->
<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th>S.No</th>
                <th>Client</th>
                <th>Applicant Name</th>
                <th>App ID</th>
                <th>Link</th>
                <th>Country</th>
                <th>Price</th>
                <th>Rate</th>
                <th>Add</th>
                <th>Type</th>
                <th class="text-right">Amount</th>
                <th class="text-right">Amount N</th>
                <th style="white-space: nowrap;">Date</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for transaction in transactions %}
            <tr class="transaction-row {% if transaction.is_paid %}row-paid{% endif %}" 
                data-paid="{{ transaction.is_paid or 0 }}" 
                data-amount="{{ transaction.amount or 0 }}" 
                data-amount-n="{{ transaction.amount_n or 0 }}">
                <td>{{ loop.index }}</td>
                <td>{{ transaction.client_name }}</td>
                <td>{{ transaction.applicant_name }}</td>
                <td>{{ transaction.app_id }}</td>
                <td>
                    {% if transaction.email_link %}
                    <a href="{{ transaction.email_link }}" target="_blank" class="btn btn-primary btn-sm" title="Open Link" style="padding: 2px 6px; font-size: 14px;">ðŸ”—</a>
                    {% endif %}
                </td>
                <td>{{ transaction.country_name }}</td>
                <td><span class="country-price-logo">{{ (transaction.country_price or 0)|comma2 }}</span></td>
                <td class="text-right">{{ (transaction.rate or 0)|comma2 }}</td>
                <td class="text-right">{{ (transaction.addition or 0)|comma2 }}</td>
                <td>{{ transaction.service_type }}</td>
                <td class="text-right">$ {{ (transaction.amount or 0)|comma2 }}</td>
                <td class="text-right"><strong>{{ (transaction.amount_n or 0)|comma2 }}</strong></td>
                <td style="white-space: nowrap;">{{ transaction.transaction_date|date_format }}</td>
                <td class="action-cell">
                    {% if not transaction.is_paid %}
                    <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-secondary btn-sm" title="Edit">âœŽ</a>
                    {% endif %}
                    {% if session.permissions and session.permissions.is_admin %}
                    {% if not transaction.is_paid %}
                    <form action="{{ url_for('pay_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Pay {{ transaction.amount_n|comma2 }} from client balance?');">
                        <button type="submit" class="btn btn-success btn-sm" title="Pay">ðŸ’³</button>
                    </form>
                    {% else %}
                    <form action="{{ url_for('undo_pay_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Undo payment and restore client balance?');">
                        <button type="submit" class="btn btn-secondary btn-sm" title="Undo Pay">â†©</button>
                    </form>
                    {% endif %}
                    {% endif %}
                    {% if not transaction.is_paid %}
                    <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                          method="POST" 
                          style="display: inline;"
                          onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                        <button type="submit" class="btn btn-danger btn-sm" title="Delete">ðŸ—‘</button>
                    </form>
                    {% endif %}
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Mobile Card View -->
<div class="mobile-card-view">
    {% for transaction in transactions %}
    <div class="mobile-card {% if transaction.is_paid %}card-paid{% endif %}"
         data-paid="{{ transaction.is_paid or 0 }}" 
         data-amount="{{ transaction.amount or 0 }}" 
         data-amount-n="{{ transaction.amount_n or 0 }}">
        <div class="mobile-card-header">#{{ loop.index }} - {{ transaction.client_name }}</div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Applicant Name:</span>
            <span class="mobile-card-value">{{ transaction.applicant_name }}</span>
        </div>
        <div class="mobile-card-row" style="justify-content: center; align-items: center; gap: 10px;">
            <span class="mobile-card-label-sm">App ID:</span>
            <span class="mobile-card-value-sm" style="font-weight: bold;">{{ transaction.app_id }}</span>
            {% if transaction.email_link %}
            <span class="mobile-card-value-sm">
                <a href="{{ transaction.email_link }}" target="_blank" class="btn btn-primary btn-sm" style="padding: 2px 8px; font-size: 12px;">Open Link</a>
            </span>
            {% endif %}
        </div>

        <div class="mobile-card-row" style="justify-content: center; background-color: #f8f9fa; padding: 4px; border-radius: 4px; margin: 4px 0;">
            <span class="mobile-card-value-sm" style="font-weight: bold; width: 100%; text-align: center;">({{ transaction.country_name }} - <span class="country-price-logo">{{ (transaction.country_price or 0)|comma2 }}</span>)</span>
        </div>

        <div class="mobile-card-row mobile-grouped-row">
            <div class="mobile-half-col">
                <span class="mobile-card-label-sm">Rate:</span>
                <span class="mobile-card-value-sm">{{ (transaction.rate or 0)|comma2 }}</span>
            </div>
            <div class="mobile-half-col">
                <span class="mobile-card-label-sm">Add:</span>
                <span class="mobile-card-value-sm">{{ (transaction.addition or 0)|comma2 }}</span>
            </div>
        </div>

        <div class="mobile-card-row" style="justify-content: center; background-color: #f8f9fa; padding: 4px; border-radius: 4px; margin: 4px 0;">
            <span class="mobile-card-value-sm" style="font-weight: bold; width: 100%; text-align: center;">$ {{ (transaction.amount or 0)|comma2 }} - <strong>â‚¦ {{ (transaction.amount_n or 0)|comma2 }}</strong></span>
        </div>
        <div class="mobile-card-row">
            <span class="mobile-card-label">Date:</span>
            <span class="mobile-card-value">{{ transaction.transaction_date|date_format }}</span>
        </div>
        <div class="mobile-card-actions">
            {% if not transaction.is_paid %}
            <a href="{{ url_for('edit_transaction', transaction_id=transaction.id) }}" class="btn btn-secondary btn-sm">Edit</a>
            {% endif %}
            {% if session.permissions and session.permissions.is_admin %}
            {% if not transaction.is_paid %}
            <form action="{{ url_for('pay_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Pay {{ transaction.amount_n|comma2 }} from client balance?');">
                <button type="submit" class="btn btn-success btn-sm" style="width: 100%;">Pay</button>
            </form>
            {% else %}
            <form action="{{ url_for('undo_pay_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Undo payment and restore client balance?');">
                <button type="submit" class="btn btn-secondary btn-sm" style="width: 100%;">Undo Pay</button>
            </form>
            {% endif %}
            {% endif %}
            {% if not transaction.is_paid %}
            <form action="{{ url_for('delete_transaction', transaction_id=transaction.id) }}" 
                  method="POST" 
                  style="display: inline; flex: 1;"
                  onsubmit="return confirm('Are you sure you want to delete this transaction?');">
                <button type="submit" class="btn btn-danger btn-sm" style="width: 100%;">ðŸ—‘</button>
            </form>
            {% endif %}
        </div>
    </div>
    {% endfor %}
</div>
{% else %}
<p class="empty-state">No transactions yet. <a href="{{ url_for('add_transaction') }}">Add your first transaction</a></p>
{% endif %}

<!-- Summary and Query Info -->
{% if transactions %}
<div class="transaction-summary" style="margin-top: 30px; padding: 20px; background-color: #f5f5f5; border-radius: 5px;">
    <h3>Transaction Summary</h3>
    
    <!-- Query Info -->
    <div style="margin-bottom: 15px; padding: 10px; background-color: white; border-radius: 3px;">
        <strong>Query Results:</strong>
        <p style="margin: 5px 0;">
            Total Transactions: <strong id="total-count">{{ transactions|length }}</strong>
            {% if filters.client %}| Client: <strong>{{ filters.client }}</strong>{% endif %}
            {% if filters.country %}| Country: <strong>{{ filters.country }}</strong>{% endif %}
            {% if filters.date_from %}| From: <strong>{{ filters.date_from }}</strong>{% endif %}
            {% if filters.date_to %}| To: <strong>{{ filters.date_to }}</strong>{% endif %}
        </p>
    </div>
    
    <!-- Sums -->
    <div style="padding: 10px; background-color: white; border-radius: 3px; border-left: 4px solid #28a745;">
        <strong style="font-size: 16px;">Sum Amount:</strong> <span id="sum-amount" style="font-size: 16px; color: #28a745;">{{ (sums['sum_amount'] or 0)|comma2 }}</span>
        <br>
        <strong style="font-size: 16px;">Sum Amount N:</strong> <span id="sum-amount-n" style="font-size: 16px; color: #28a745;">{{ (sums['sum_amount_n'] or 0)|comma2 }}</span>
    </div>
</div>
{% endif %}

<script>
    // Store original export URLs
    let originalExportPdfUrl = "";
    let originalExportJpegUrl = "";

    function filterTransactions(status) {
        // Update tabs
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        if (status === 'all') document.getElementById('tab-all').classList.add('active');
        else if (status === '0') document.getElementById('tab-pending').classList.add('active');
        else if (status === '1') document.getElementById('tab-paid').classList.add('active');

        let visibleCount = 0;
        let sumAmount = 0;
        let sumAmountN = 0;
        let rowSerial = 1;

        // Process Table Rows
        const rows = document.querySelectorAll('.transaction-row');
        rows.forEach(row => {
            const isPaid = row.getAttribute('data-paid') === '1' || row.getAttribute('data-paid') === 'True';
            const amount = parseFloat(row.getAttribute('data-amount')) || 0;
            const amountN = parseFloat(row.getAttribute('data-amount-n')) || 0;
            
            let show = false;
            if (status === 'all') show = true;
            else if (status === '0' && !isPaid) show = true;
            else if (status === '1' && isPaid) show = true;

            if (show) {
                row.style.display = '';
                // Update Serial Number
                const sNoCell = row.querySelector('.s-no');
                if (sNoCell) sNoCell.textContent = rowSerial++;
                
                // Update Sums (only count once per transaction, so we do it here in the rows loop)
                visibleCount++;
                sumAmount += amount;
                sumAmountN += amountN;
            } else {
                row.style.display = 'none';
            }
        });

        // Process Mobile Cards (separate loop to keep serials in sync but not double-count sums)
        let cardSerial = 1;
        const cards = document.querySelectorAll('.mobile-card');
        cards.forEach(card => {
            const isPaid = card.getAttribute('data-paid') === '1' || card.getAttribute('data-paid') === 'True';
            
            let show = false;
            if (status === 'all') show = true;
            else if (status === '0' && !isPaid) show = true;
            else if (status === '1' && isPaid) show = true;

            if (show) {
                card.style.display = '';
                // Update Serial Number
                const sNoSpan = card.querySelector('.card-s-no');
                if (sNoSpan) sNoSpan.textContent = '#' + (cardSerial++);
            } else {
                card.style.display = 'none';
            }
        });

        // Update summaries
        const totalCountEl = document.getElementById('total-count');
        const sumAmountEl = document.getElementById('sum-amount');
        const sumAmountNEl = document.getElementById('sum-amount-n');

        if (totalCountEl) totalCountEl.textContent = visibleCount;
        if (sumAmountEl) sumAmountEl.textContent = sumAmount.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});
        if (sumAmountNEl) sumAmountNEl.textContent = sumAmountN.toLocaleString(undefined, {minimumFractionDigits: 0, maximumFractionDigits: 0});

        // Update Export Links
        const pdfBtn = document.getElementById('export-pdf');
        const jpegBtn = document.getElementById('export-jpeg');
        
        if (pdfBtn && originalExportPdfUrl) {
            const url = new URL(originalExportPdfUrl, window.location.origin);
            url.searchParams.set('paid', status);
            pdfBtn.href = url.toString();
        }
        if (jpegBtn && originalExportJpegUrl) {
            const url = new URL(originalExportJpegUrl, window.location.origin);
            url.searchParams.set('paid', status);
            jpegBtn.href = url.toString();
        }
    }

    document.addEventListener('DOMContentLoaded', function() {
        // Capture original URLs
        const pdfBtn = document.getElementById('export-pdf');
        const jpegBtn = document.getElementById('export-jpeg');
        if (pdfBtn) originalExportPdfUrl = pdfBtn.href;
        if (jpegBtn) originalExportJpegUrl = jpegBtn.href;

        // Initialize with server-provided filter or default to Pending
        // filters.paid comes from backend (defaults to '0')
        const initialStatus = "{{ filters.paid }}";
        filterTransactions(initialStatus);

        const dateFrom = document.getElementById('date_from').value;

        const dateTo = document.getElementById('date_to').value;
        const defaultDate = [];
        if (dateFrom) defaultDate.push(dateFrom);
        if (dateTo) defaultDate.push(dateTo);

        flatpickr("#date_range", {
            mode: "range",
            dateFormat: "Y-m-d",
            defaultDate: defaultDate,
            onClose: function(selectedDates, dateStr, instance) {
                if (selectedDates.length === 2) {
                    document.getElementById('date_from').value = instance.formatDate(selectedDates[0], "Y-m-d");
                    document.getElementById('date_to').value = instance.formatDate(selectedDates[1], "Y-m-d");
                } else if (selectedDates.length === 1) {
                    document.getElementById('date_from').value = instance.formatDate(selectedDates[0], "Y-m-d");
                    document.getElementById('date_to').value = instance.formatDate(selectedDates[0], "Y-m-d");
                } else {
                    document.getElementById('date_from').value = "";
                    document.getElementById('date_to').value = "";
                }
            }
        });
    });
</script>
{% endblock %}
